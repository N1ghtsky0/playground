<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <meta name="_csrf" content="{{_csrf.token}}"/>
  <meta name="_csrf_header" content="{{_csrf.headerName}}"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
</head>
<body>
<div class="container">
  <h1 class="my-3">회원 가입 페이지</h1>
  <form class="border" method="post" id="frm">
    <input type="hidden" name="{{_csrf.parameterName}}" value="{{_csrf.token}}">
    <input type="hidden" id="idChkStatus" value="N">
    <div class="m-3">
      <div class="mb-3">
        <label for="loginId" class="form-label">아이디</label>
        <input type="text" class="form-control mb-1" id="loginId" name="loginId">
        <div class="d-flex justify-content-start">
          <a href="javascript:fn_checkLoginIdDuplicate();" class="btn btn-dark btn-sm me-3" id="idDupBtn">중복 체크</a>
          <div class="form-text" id="idDupTxt">아이디 중복 확인을 해주세요</div>
        </div>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">비밀번호</label>
        <input type="password" class="form-control" id="password" name="password" disabled>
      </div>
      <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-primary" id="submitBtn" disabled>회원가입</button>
      </div>
    </div>
  </form>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
  $("#password").keyup(function () {
    const submitBtn = $("#submitBtn");
    if ($("#password").val().length === 0) {
      submitBtn.attr("disabled", true);
    } else {
      submitBtn.attr("disabled", false);
    }
  });

  $("#loginId").keyup(function () {
    $("#idChkStatus").val("N");
  });

  $("#submitBtn").click(function () {
    if ($("#idChkStatus").val() === "N") {
      alert("아이디 중복 확인을 해주세요.");
      $("#idDupTxt").css("color", "black").text("아이디 중복 확인을 해주세요.");
    } else {
      $("#frm").attr("action", "/join").submit();
    }
  });

  function fn_checkLoginIdDuplicate() {
    const loginId = $("#loginId").val();
    const token = $("meta[name='_csrf']").attr("content")
    const header = $("meta[name='_csrf_header']").attr("content");
    if (loginId === "") {
      alert("아이디를 입력해주세요.");
    } else {
      $.ajax({
        url: "/valid/id",
        type: "post",
        dataType: "json",
        data: {"loginId": loginId},
        beforeSend: function (xhr) {
          xhr.setRequestHeader(header, token);
        },
        success: function (res) {
          if (!res) {
            $("#idDupTxt").css("color", "blue").text("사용 가능한 아이디입니다.");
            $("#password").removeAttr("disabled")
            $("#idChkStatus").val("Y");
          } else {
            $("#idDupTxt").css("color", "red").text("사용 불가능한 아이디입니다.");
            $("#password").attr("disabled", true)
          }
        },
        error: function (res) {
          alert("새로 고침 후 다시 시도해주세요.");
          console.log(res);
        },
      })
    }
  }
</script>
</body>
</html>